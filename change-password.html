function doPost(e) {
  try {
    // Log the entire event object for debugging
    Logger.log('Full event object: ' + JSON.stringify(e, null, 2));

    // Initialize data object
    let data = {};
    let isJson = false;

    // Handle JSON or FormData
    if (e.postData && e.postData.contents) {
      try {
        data = JSON.parse(e.postData.contents);
        isJson = true;
        Logger.log('Received JSON data: ' + JSON.stringify(data));
      } catch (parseError) {
        // If JSON parsing fails, try as FormData
        Logger.log('Failed to parse as JSON, trying as FormData');
        data = e.parameter;
      }
    } else if (e.parameter) {
      // Handle FormData (parameters)
      data = e.parameter;
      Logger.log('Received FormData: ' + JSON.stringify(data));
    } else {
      throw new Error('Invalid request: Missing postData or parameters');
    }

    // Check if this is a password change request
    if (data.action === 'changePassword') {
      return handlePasswordChange(data, isJson);
    }

    // Rest of your existing doPost code...
    // ... [keep your existing record update code here]

  } catch (error) {
    Logger.log('Error: ' + error.message + '\nStack: ' + error.stack);
    return createErrorResponse(error.message, isJson);
  }
}

function handlePasswordChange(data, isJson) {
  try {
    const recordId = data.recordId || '111';
    const currentPassword = data.currentPassword;
    const newPassword = data.newPassword;
    
    if (!currentPassword || !newPassword) {
      throw new Error('Current password and new password are required');
    }
    
    // Open the Google Sheet
    const spreadsheetId = '1IpgOJOIXEOlWaKhPXFAV4kWGJVw8WlfIaJHWicFSK-c';
    const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    const sheet = spreadsheet.getSheetByName('BusinessCard');
    
    if (!sheet) {
      throw new Error('Sheet "BusinessCard" not found');
    }
    
    // Get headers to find password column
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    
    // Find the ID and password column indices
    let idColumnIndex = -1;
    let passwordColumnIndex = -1;
    
    for (let i = 0; i < headers.length; i++) {
      const header = headers[i].toLowerCase().trim();
      if (header === 'id') {
        idColumnIndex = i;
      } else if (header === 'password') {
        passwordColumnIndex = i;
      }
    }
    
    if (idColumnIndex === -1) {
      throw new Error('ID column not found in sheet');
    }
    
    if (passwordColumnIndex === -1) {
      throw new Error('Password column not found in sheet');
    }
    
    // Get all data to find the matching row
    const allData = sheet.getDataRange().getValues();
    
    // Find the row with the matching ID
    let targetRowIndex = -1;
    let storedPassword = '';
    
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][idColumnIndex] == recordId) {
        targetRowIndex = i;
        storedPassword = allData[i][passwordColumnIndex] || '';
        break;
      }
    }
    
    if (targetRowIndex === -1) {
      throw new Error('Record with ID "' + recordId + '" not found');
    }
    
    // Verify current password
    if (storedPassword !== currentPassword) {
      throw new Error('Current password is incorrect');
    }
    
    // Update password
    sheet.getRange(targetRowIndex + 1, passwordColumnIndex + 1).setValue(newPassword);
    
    return createSuccessResponse('Password updated successfully', isJson);
    
  } catch (error) {
    Logger.log('Password change error: ' + error.message);
    return createErrorResponse(error.message, isJson);
  }
}

function createSuccessResponse(message, isJson) {
  const response = {
    status: 'success',
    message: message
  };
  
  if (isJson) {
    return ContentService.createTextOutput(JSON.stringify(response))
      .setMimeType(ContentService.MimeType.JSON);
  } else {
    return HtmlService.createHtmlOutput(JSON.stringify(response))
      .setMimeType(ContentService.MimeType.HTML);
  }
}

function createErrorResponse(message, isJson) {
  const response = {
    status: 'error',
    message: message
  };
  
  if (isJson) {
    return ContentService.createTextOutput(JSON.stringify(response))
      .setMimeType(ContentService.MimeType.JSON);
  } else {
    return HtmlService.createHtmlOutput(JSON.stringify(response))
      .setMimeType(ContentService.MimeType.HTML);
  }
}
